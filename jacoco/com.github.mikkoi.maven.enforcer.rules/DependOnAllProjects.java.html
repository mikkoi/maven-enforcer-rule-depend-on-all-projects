<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DependOnAllProjects.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Maven Enforcer Rule dependOnAllProjects</a> &gt; <a href="index.source.html" class="el_package">com.github.mikkoi.maven.enforcer.rules</a> &gt; <span class="el_source">DependOnAllProjects.java</span></div><h1>DependOnAllProjects.java</h1><pre class="source lang-java linenums">package com.github.mikkoi.maven.enforcer.rules;

import javax.annotation.Nullable;
import javax.inject.Inject;
import javax.inject.Named;

import org.apache.maven.enforcer.rule.api.AbstractEnforcerRule;
import org.apache.maven.enforcer.rule.api.EnforcerRuleException;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Dependency;
import org.apache.maven.project.MavenProject;

import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.function.Predicate;

/**
 * Maven Enforcer Custom Rule.
 */
<span class="fc" id="L23">@Named(&quot;dependOnAllProjects&quot;)</span>
public class DependOnAllProjects extends AbstractEnforcerRule {

    /**
     * Constant value: Size of indentation inside a &amp;lt;dependency&gt;&amp;gt; definition.
     */
    private static final String INDENT_DEPENDENCY = &quot;    &quot;;
    /**
     * Constant value: Maximum number of parts in a dependency declaration.
     */
    private static final int MAX_NUM_PARTS_IN_DEPENDENCY_DECLARATION = 3;
    /**
     * Constant value for faking boolean parameter false.
     */
    private static final String FALSE = &quot;false&quot;;
    /**
     * Constant value for faking boolean parameter true.
     */
    private static final String TRUE = &quot;true&quot;;
    /**
     * Inject needed Maven component.
      */
    private final MavenSession mavenSession;
    /**
     * Include by project [groupId:]artifactId[:packagingType].
     * Default value: all projects included.
     */
    private List&lt;String&gt; includes;
    /**
     * Exclude by project [groupId:]artifactId[:packagingType].
     * Default value: No projects excluded.
     * If includes list contains any items, they are evaluated first.
     * Then excludes are excluded from them.
     */
    private List&lt;String&gt; excludes;
    /**
     * Error if unknown project in includes/excludes.
     * If a wildcard (*) is used in the name, this parameter has no effect.
     */
    @SuppressWarnings(&quot;unused&quot;) // Not actually unused. Set via Plexus/Sisu Container.
    private String errorIfUnknownProject;
    /**
     * Include Maven root project.
     */
    @SuppressWarnings(&quot;unused&quot;) // Not actually unused. Set via Plexus/Sisu Container.
    private String includeRootProject;

    /**
     * Constructor.
     *
     * @param session            Initialized MavenSession object.
     */
    @Inject
    @SuppressFBWarnings
<span class="fc" id="L77">    public DependOnAllProjects(MavenSession session) {</span>
<span class="fc" id="L78">        this.mavenSession = Objects.requireNonNull(session);</span>
<span class="fc" id="L79">    }</span>

    /**
     * Set includes.
     * @param includes the includes
     */
    @Inject
    public void setIncludes(@Nullable List&lt;String&gt; includes) {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (includes == null) {</span>
<span class="fc" id="L88">            this.includes = new ArrayList&lt;&gt;();</span>
        } else {
<span class="fc" id="L90">            this.includes = new ArrayList&lt;&gt;(includes);</span>
        }
<span class="fc" id="L92">    }</span>

    /**
     * Set excludes.
     * @param excludes the excludes
     */
    @Inject
    public void setExcludes(@Nullable List&lt;String&gt; excludes) {
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (excludes == null) {</span>
<span class="fc" id="L101">            this.excludes = new ArrayList&lt;&gt;();</span>
        } else {
<span class="fc" id="L103">            this.excludes = new ArrayList&lt;&gt;(excludes);</span>
        }
<span class="fc" id="L105">    }</span>

    /**
     * Set errorIfUnknownProject.
     * @param errorIfUnknownProject the errorIfUnknownProject
     */
    @Inject
    public void setErrorIfUnknownProject(String errorIfUnknownProject) {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (errorIfUnknownProject != null) {</span>
<span class="fc" id="L114">            this.errorIfUnknownProject = errorIfUnknownProject;</span>
        } else {
<span class="fc" id="L116">            this.errorIfUnknownProject = FALSE;</span>
        }
<span class="fc" id="L118">    }</span>

    /**
     * Set includeRootProject.
     * @param includeRootProject the includeRootProject
     */
    @Inject
    public void setIncludeRootProject(String includeRootProject) {
<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (includeRootProject != null) {</span>
<span class="fc" id="L127">            this.includeRootProject = includeRootProject;</span>
        } else {
<span class="fc" id="L129">            this.includeRootProject = FALSE;</span>
        }
<span class="fc" id="L131">    }</span>

    /**
     * Format Dependency object to XML snippet.
     * User can simply copy-paste this to the project.
     * @param dependency Dependency object
     * @param indent     Indentation string, e.g. &quot;    &quot;
     * @return Formatted XML snippet
     */
    public static String formatDependency(Dependency dependency, String indent) {
<span class="fc" id="L141">        final String newLine = System.lineSeparator();</span>
<span class="fc" id="L142">        final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L143">        sb.append(&quot;&lt;dependency&gt;&quot;).append(newLine);</span>
<span class="fc" id="L144">        sb.append(indent).append(String.format(&quot;&lt;groupId&gt;%s&lt;/groupId&gt;&quot;, dependency.getGroupId()))</span>
<span class="fc" id="L145">            .append(newLine);</span>
<span class="fc" id="L146">        sb.append(indent)</span>
<span class="fc" id="L147">            .append(String.format(&quot;&lt;artifactId&gt;%s&lt;/artifactId&gt;&quot;, dependency.getArtifactId()))</span>
<span class="fc" id="L148">            .append(newLine);</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (!&quot;jar&quot;.equals(dependency.getType())) {</span>
<span class="fc" id="L150">            sb.append(indent).append(String.format(&quot;&lt;type&gt;%s&lt;/type&gt;&quot;, dependency.getType()))</span>
<span class="fc" id="L151">                .append(newLine);</span>
        }
<span class="fc" id="L153">        sb.append(&quot;&lt;/dependency&gt;&quot;);</span>
<span class="fc" id="L154">        return sb.toString();</span>
    }

    /**
     * Convert string for matching.
     *
     * @param s String
     * @return converted string
     */
    public static String convertStringForMatching(String s) {
<span class="fc" id="L164">        String t = s.replace(&quot;.&quot;, &quot;\\.&quot;);</span>
<span class="fc" id="L165">        t = t.replace(&quot;*&quot;, &quot;.*&quot;);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (!t.contains(&quot;:&quot;)) {</span>
<span class="fc" id="L167">            t = &quot;.*:&quot; + t + &quot;:.*&quot;;</span>
        }
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (Arrays.stream(t.split(&quot;:&quot;)).count() &lt; MAX_NUM_PARTS_IN_DEPENDENCY_DECLARATION) {</span>
<span class="fc" id="L170">            t = t + &quot;:.*&quot;;</span>
        }
<span class="fc" id="L172">        return t;</span>
    }

    /**
     * Compare two MavenProject objects.
     * GroupId, ArtifactId, Version and Packaging must match.
     *
     * @param a MavenProject a
     * @param b MavenProject b
     * @return true if projects are equal
     */
    public static boolean projectsAreEquals(MavenProject a, MavenProject b) {
<span class="fc bfc" id="L184" title="All 2 branches covered.">        return a.getGroupId().equals(b.getGroupId())</span>
<span class="fc bfc" id="L185" title="All 4 branches covered.">            &amp;&amp; a.getArtifactId().equals(b.getArtifactId()) &amp;&amp; a.getVersion().equals(b.getVersion())</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">            &amp;&amp; a.getPackaging().equals(b.getPackaging());</span>
    }

    /**
     * Compare two Dependency objects.
     * GroupId, ArtifactId, Version and Type must match.
     *
     * @param a Dependency a
     * @param b Dependency b
     * @return true if dependencies are equal
     */
    public static boolean dependenciesAreEquals(Dependency a, Dependency b) {
<span class="fc bfc" id="L198" title="All 2 branches covered.">        return a.getGroupId().equals(b.getGroupId())</span>
<span class="pc bpc" id="L199" title="2 of 4 branches missed.">            &amp;&amp; a.getArtifactId().equals(b.getArtifactId()) &amp;&amp; a.getVersion().equals(b.getVersion())</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            &amp;&amp; a.getType().equals(b.getType());</span>
    }

    /**
     * Does the list (Iterable) of Dependency objects contain the MavenProject?
     *
     * @param projects Iterable of Dependency objects
     * @param project  a Maven project object
     * @return true if project is found
     */
    public static boolean dependenciesContains(Iterable&lt;Dependency&gt; projects,
                                               MavenProject project) {
<span class="fc bfc" id="L212" title="All 2 branches covered.">        for (Dependency p : projects) {</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">            if (dependenciesAreEquals(p, projectToDependency(project))) {</span>
<span class="fc" id="L214">                return true;</span>
            }
<span class="fc" id="L216">        }</span>
<span class="fc" id="L217">        return false;</span>
    }

    /**
     * Does any of the projects in Maven Reactor build match with this project name?
     * Name must not have a wildcard!
     *
     * @param projects    Iterable of MavenProject objects
     * @param projectName Project name, e.g. &quot;artifactId&quot;, &quot;groupId:artifactId&quot;, &quot;groupId:artifactId:packingType&quot;.
     * @return Boolean
     */
    public static boolean projectsContains(Iterable&lt;MavenProject&gt; projects, String projectName) {
<span class="fc" id="L229">        List&lt;String&gt; ids = Arrays.asList(projectName.split(&quot;:&quot;));</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">        for (MavenProject project : projects) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (ids.size() == 1) {</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">                if (project.getArtifactId().equals(ids.get(0))) {</span>
<span class="fc" id="L233">                    return true;</span>
                }
<span class="fc bfc" id="L235" title="All 2 branches covered.">            } else if (ids.size() == 2) {</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">                if (project.getGroupId().equals(ids.get(0))</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">                    &amp;&amp; project.getArtifactId().equals(ids.get(1))) {</span>
<span class="fc" id="L238">                    return true;</span>
                }
            } else {
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                assert ids.size() == MAX_NUM_PARTS_IN_DEPENDENCY_DECLARATION;</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                if (project.getGroupId().equals(ids.get(0))</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">                    &amp;&amp; project.getArtifactId().equals(ids.get(1))</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">                    &amp;&amp; project.getPackaging().equals(ids.get(2))) {</span>
<span class="fc" id="L245">                    return true;</span>
                }
            }
<span class="fc" id="L248">        }</span>
<span class="fc" id="L249">        return false;</span>
    }

    /**
     * Convert MavenProject to Dependency object.
     *
     * @param mavenProject MavenProject object
     * @return Dependency object
     */
    public static Dependency projectToDependency(MavenProject mavenProject) {
<span class="fc" id="L259">        Dependency d = new Dependency();</span>
<span class="fc" id="L260">        d.setGroupId(mavenProject.getGroupId());</span>
<span class="fc" id="L261">        d.setArtifactId(mavenProject.getArtifactId());</span>
<span class="fc" id="L262">        d.setVersion(mavenProject.getVersion());</span>
<span class="fc" id="L263">        d.setType(mavenProject.getPackaging());</span>
<span class="fc" id="L264">        return d;</span>
    }

    /**
     * Match projects with includes and excludes.
     * Includes are * by default. Then excludes are excluded from the includes.
     *
     * @param includes     Included projects. Default: *
     * @param excludes     Excluded projects. Default: none
     * @param mavenProject Initialized MavenProject object.
     * @return True or false.
     */
    public static boolean isProjectIncluded(List&lt;String&gt; includes, List&lt;String&gt; excludes,
                                            MavenProject mavenProject) {
<span class="fc" id="L278">        String projectId =</span>
<span class="fc" id="L279">            String.format(&quot;%s:%s:%s&quot;, mavenProject.getGroupId(), mavenProject.getArtifactId(),</span>
<span class="fc" id="L280">                mavenProject.getPackaging());</span>

        // Match from the end of the id, artifactId alone is enough.
<span class="fc" id="L283">        Predicate&lt;String&gt; predicateForProjectId =</span>
<span class="fc" id="L284">            s -&gt; projectId.matches(convertStringForMatching(s));</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">        return includes.stream().anyMatch(predicateForProjectId)</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">            &amp;&amp; excludes.stream().noneMatch(predicateForProjectId);</span>
    }

    /**
     * Validate parameters provided via properties
     * either on the command line or using configuration element in pom.
     *
     * @throws EnforcerRuleException if parameter validation fails.
     */
    void validateAndPrepareParameters() throws EnforcerRuleException {
<span class="fc" id="L296">        getLog().debug(&quot;includes=&quot; + includes);</span>
<span class="fc" id="L297">        getLog().debug(&quot;excludes=&quot; + excludes);</span>
<span class="fc" id="L298">        getLog().debug(&quot;errorIfUnknownProject=&quot; + errorIfUnknownProject);</span>
<span class="fc" id="L299">        getLog().debug(&quot;includeRootProject=&quot; + includeRootProject);</span>

<span class="fc" id="L301">        final List&lt;MavenProject&gt; reactorProjects =</span>
<span class="fc" id="L302">            mavenSession.getProjectDependencyGraph().getSortedProjects();</span>
<span class="fc" id="L303">        getLog().debug(&quot;reactorProjects=&quot; + reactorProjects);</span>

        /* There is a bug in Maven/Sisu/Plexus container, which sets includes to a list with one empty string,
         * if the parameter is not set. So we need to check for this case and convert it to an empty list.
         * Then we can add the default value of &quot;*&quot;.
         */
<span class="pc bpc" id="L309" title="1 of 6 branches missed.">        if ((includes == null) || (includes.size() == 1 &amp;&amp; &quot;&quot;.equals(includes.get(0)))) {</span>
<span class="fc" id="L310">            includes = new ArrayList&lt;&gt;();</span>
        }
<span class="fc bfc" id="L312" title="All 2 branches covered.">        if (excludes == null) {</span>
<span class="fc" id="L313">            excludes = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L314" title="1 of 4 branches missed.">        } else if (excludes.size() == 1 &amp;&amp; &quot;&quot;.equals(excludes.get(0))) {</span>
<span class="nc" id="L315">            excludes = new ArrayList&lt;&gt;();</span>
        }
<span class="fc" id="L317">        getLog().debug(String.format(&quot;Parameter includes.size: %d&quot;, includes.size()));</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">        for (String a : includes) {</span>
<span class="fc" id="L319">            getLog().debug(String.format(&quot;Check include '%s'&quot;, a));</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">            if (a == null) {</span>
<span class="nc" id="L321">                throw new EnforcerRuleException(</span>
                    &quot;Failure in parameter 'includes'. String is null&quot;);
            }
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">            if (a.matches(&quot;^[\t\n ]+$&quot;)) {</span>
<span class="nc" id="L325">                throw new EnforcerRuleException(</span>
<span class="nc" id="L326">                    String.format(&quot;Failure in parameter 'includes'. String contains only whitespace: '%s'&quot;, a));</span>
            }
<span class="fc" id="L328">            List&lt;String&gt; ids = Arrays.asList(a.split(&quot;:&quot;));</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">            if (ids.size() &gt; MAX_NUM_PARTS_IN_DEPENDENCY_DECLARATION) {</span>
<span class="nc" id="L330">                throw new EnforcerRuleException(</span>
                    &quot;Failure in parameter 'includes'. String is invalid&quot;);
            }
            /* If there is a wildcard, we cannot check if the project exists in the build.
             * So we skip the check in this case.
             */
<span class="pc bpc" id="L336" title="2 of 4 branches missed.">            if (TRUE.equals(errorIfUnknownProject) &amp;&amp; !a.contains(&quot;*&quot;)</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">                &amp;&amp; !projectsContains(reactorProjects, a)) {</span>
<span class="nc" id="L338">                throw new EnforcerRuleException(String.format(</span>
                    &quot;Failure in parameter 'includes'. Project '%s' not found in build&quot;, a));
            }
<span class="fc" id="L341">        }</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (includes.isEmpty()) {</span>
<span class="fc" id="L343">            includes.add(&quot;*&quot;);</span>
        }

<span class="fc" id="L346">        getLog().debug(String.format(&quot;Parameter excludes.size: %d&quot;, excludes.size()));</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">        for (String a : excludes) {</span>
<span class="fc" id="L348">            getLog().debug(String.format(&quot;Check exclude '%s'&quot;, a));</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">            if (a == null) {</span>
<span class="nc" id="L350">                throw new EnforcerRuleException(</span>
                    &quot;Failure in parameter 'excludes'. String is null&quot;);
            }
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">            if (a.matches(&quot;^[\t\n ]+$&quot;)) {</span>
<span class="nc" id="L354">                throw new EnforcerRuleException(</span>
<span class="nc" id="L355">                    String.format(&quot;Failure in parameter 'excludes'. String contains only whitespace: '%s'&quot;, a));</span>
            }
<span class="fc" id="L357">            List&lt;String&gt; ids = Arrays.asList(a.split(&quot;:&quot;));</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (ids.size() &gt; MAX_NUM_PARTS_IN_DEPENDENCY_DECLARATION) {</span>
<span class="nc" id="L359">                throw new EnforcerRuleException(</span>
                    &quot;Failure in parameter 'excludes'. String is invalid&quot;);
            }
            /* If there is a wildcard, we cannot check if the project exists in the build.
             * So we skip the check in this case.
             */
<span class="pc bpc" id="L365" title="2 of 4 branches missed.">            if (TRUE.equals(errorIfUnknownProject) &amp;&amp; !a.contains(&quot;*&quot;)</span>
<span class="pc bpc" id="L366" title="1 of 2 branches missed.">                &amp;&amp; !projectsContains(reactorProjects, a)) {</span>
<span class="nc" id="L367">                throw new EnforcerRuleException(String.format(</span>
                    &quot;Failure in parameter 'excludes'. Project '%s' not found in build&quot;, a));
            }
<span class="fc" id="L370">        }</span>

<span class="pc bpc" id="L372" title="1 of 4 branches missed.">        if (errorIfUnknownProject == null || errorIfUnknownProject.isEmpty()) {</span>
<span class="fc" id="L373">            errorIfUnknownProject = FALSE;</span>
        }
<span class="pc bpc" id="L375" title="1 of 4 branches missed.">        if (includeRootProject == null || includeRootProject.isEmpty()) {</span>
<span class="fc" id="L376">            includeRootProject = FALSE;</span>
        }
<span class="pc bpc" id="L378" title="1 of 4 branches missed.">        if (!TRUE.equals(errorIfUnknownProject) &amp;&amp; !FALSE.equals(errorIfUnknownProject)) {</span>
<span class="nc" id="L379">            throw new EnforcerRuleException(</span>
<span class="nc" id="L380">                String.format(&quot;Failure in parameter 'errorIfUnknownProject'. Must be 'true' or 'false': '%s'&quot;, errorIfUnknownProject));</span>
        }
<span class="pc bpc" id="L382" title="1 of 4 branches missed.">        if (!TRUE.equals(includeRootProject) &amp;&amp; !FALSE.equals(includeRootProject)) {</span>
<span class="nc" id="L383">            throw new EnforcerRuleException(</span>
<span class="nc" id="L384">                String.format(&quot;Failure in parameter 'includeRootProject'. Must be 'true' or 'false': '%s'&quot;, includeRootProject));</span>
        }

<span class="fc" id="L387">        getLog().debug(&quot;includes(resolved)=&quot; + includes);</span>
<span class="fc" id="L388">        getLog().debug(&quot;excludes(resolved)=&quot; + excludes);</span>
<span class="fc" id="L389">        getLog().debug(&quot;errorIfUnknownProject(resolved)=&quot; + errorIfUnknownProject);</span>
<span class="fc" id="L390">        getLog().debug(&quot;includeRootProject(resolved)=&quot; + includeRootProject);</span>
<span class="fc" id="L391">    }</span>

    /**
     * The rule logic.
     * Collect all projects in the build and filter according to includes/excludes.
     * Match the list with the dependencies of the current project.
     * If the two lists do not match, Raise EnforcerRuleException
     *
     * @throws EnforcerRuleException if rule fails.
     */
    public void dependOnAllProjects() throws EnforcerRuleException {
<span class="fc" id="L402">        List&lt;MavenProject&gt; includedProjects = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L403">        MavenProject currentProject = mavenSession.getCurrentProject();</span>
<span class="fc" id="L404">        getLog().debug(String.format(&quot;Current Project: %s:%s&quot;, currentProject.getGroupId(),</span>
<span class="fc" id="L405">            currentProject.getArtifactId()));</span>

<span class="fc" id="L407">        getLog().debug(&quot;Iterate through all projects in Maven Dependency Graph, i.e. the build.&quot;);</span>
<span class="fc" id="L408">        mavenSession.getProjectDependencyGraph().getSortedProjects().forEach(project -&gt; {</span>
<span class="fc" id="L409">            String projectId =</span>
<span class="fc" id="L410">                String.format(&quot;%s:%s:%s&quot;, project.getGroupId(), project.getArtifactId(),</span>
<span class="fc" id="L411">                    project.getVersion());</span>
<span class="fc" id="L412">            getLog().debug(&quot;    &quot; + projectId);</span>

<span class="fc bfc" id="L414" title="All 2 branches covered.">            if (isIncluded(project)) {</span>
<span class="pc bpc" id="L415" title="1 of 4 branches missed.">                if (projectsAreEquals(project, currentProject) || (!TRUE.equals(this.includeRootProject)</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">                    &amp;&amp; projectsAreEquals(project, mavenSession.getTopLevelProject()))) {</span>
<span class="fc" id="L417">                    getLog().debug(&quot;Filter out project: &quot;</span>
<span class="fc" id="L418">                        + String.format(&quot;%s:%s&quot;, project.getGroupId(), project.getArtifactId()));</span>
                } else {
<span class="fc" id="L420">                    includedProjects.add(project);</span>
                }
            }
<span class="fc" id="L423">        });</span>
<span class="fc" id="L424">        getLog().debug(&quot;includedProjects=%s&quot; + includedProjects);</span>
<span class="fc" id="L425">        List&lt;MavenProject&gt; missingProjects = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">        for (MavenProject project : includedProjects) {</span>
<span class="fc" id="L427">            @SuppressWarnings(&quot;unchecked&quot;) List&lt;Dependency&gt; dependencies =</span>
<span class="fc" id="L428">                currentProject.getDependencies();</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">            if (!dependenciesContains(dependencies, project)) {</span>
<span class="fc" id="L430">                missingProjects.add(project);</span>
            }
<span class="fc" id="L432">        }</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">        if (!missingProjects.isEmpty()) {</span>
<span class="fc" id="L434">            List&lt;String&gt; errors = new ArrayList&lt;&gt;(missingProjects.size());</span>
<span class="fc bfc" id="L435" title="All 2 branches covered.">            for (MavenProject missingProject : missingProjects) {</span>
<span class="fc" id="L436">                errors.add(String.format(&quot;Project '%s:%s' is missing dependency '%s:%s:%s'.&quot;,</span>
<span class="fc" id="L437">                    currentProject.getGroupId(), currentProject.getArtifactId(),</span>
<span class="fc" id="L438">                    missingProject.getGroupId(), missingProject.getArtifactId(),</span>
<span class="fc" id="L439">                    missingProject.getPackaging()));</span>
<span class="fc" id="L440">            }</span>
<span class="fc" id="L441">            StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L442">            sb.append(String.format(&quot;Missing definitions from the project '%s:%s':&quot;,</span>
<span class="fc" id="L443">                currentProject.getGroupId(), currentProject.getArtifactId()));</span>
<span class="fc" id="L444">            sb.append(System.lineSeparator());</span>
<span class="fc" id="L445">            sb.append(&quot;&lt;!--     Created by Maven Enforcer rule dependOnAllProjects     ---&gt;&quot;);</span>
<span class="fc" id="L446">            sb.append(System.lineSeparator());</span>
<span class="fc bfc" id="L447" title="All 2 branches covered.">            for (MavenProject missingProject : missingProjects) {</span>
<span class="fc" id="L448">                sb.append(formatDependency(projectToDependency(missingProject), INDENT_DEPENDENCY));</span>
<span class="fc" id="L449">                sb.append(System.lineSeparator());</span>
<span class="fc" id="L450">            }</span>
<span class="fc" id="L451">            sb.append(&quot;&lt;!--     / Created by Maven Enforcer rule dependOnAllProjects     ---&gt;&quot;);</span>
<span class="fc" id="L452">            errors.add(sb.toString());</span>
<span class="fc" id="L453">            throw new EnforcerRuleException(String.join(&quot;\n&quot;, errors));</span>
        }
<span class="fc" id="L455">        getLog().debug(&quot;End of iterate&quot;);</span>
<span class="fc" id="L456">    }</span>

    /**
     * The main entry point for rule.
     *
     * @throws EnforcerRuleException if rule fails.
     */
    @Override
    public void execute() throws EnforcerRuleException {
<span class="fc" id="L465">        MavenProject currentProject = mavenSession.getCurrentProject();</span>
<span class="fc" id="L466">        getLog().debug(String.format(&quot;Current Project: %s:%s&quot;, currentProject.getGroupId(),</span>
<span class="fc" id="L467">            currentProject.getArtifactId()));</span>
<span class="fc" id="L468">        MavenProject topLevelProject = mavenSession.getTopLevelProject();</span>
<span class="fc" id="L469">        getLog().debug(String.format(&quot;Top Level Project: %s:%s&quot;, topLevelProject.getGroupId(),</span>
<span class="fc" id="L470">            topLevelProject.getArtifactId()));</span>

<span class="fc" id="L472">        validateAndPrepareParameters();</span>

<span class="fc" id="L474">        dependOnAllProjects();</span>
<span class="fc" id="L475">    }</span>

    /**
     * String representation of the rule.
     * Output is used in verbose Maven logs, can help during investigate problems.
     *
     * @return rule description
     */
    @Override
    public String toString() {
<span class="fc" id="L485">        return String.format(</span>
            &quot;DependOnAllProjects[includes=%s;excludes=%s;includeRootProject=%s;errorIfUnknownProject=%s]&quot;,
            includes, excludes, includeRootProject, errorIfUnknownProject);
    }

    /**
     * Decide if the project is included or excluded.
     *
     * @param mavenProject MavenProject
     * @return true if included, false if excluded
     */
    boolean isIncluded(MavenProject mavenProject) {
<span class="fc" id="L497">        boolean r = isProjectIncluded(this.includes, this.excludes, mavenProject);</span>
<span class="fc" id="L498">        getLog().debug(String.format(&quot;isIncluded(%s:%s:%s:%s): %b&quot;, mavenProject.getGroupId(),</span>
<span class="fc" id="L499">            mavenProject.getArtifactId(), mavenProject.getVersion(), mavenProject.getPackaging(),</span>
<span class="fc" id="L500">            r));</span>
<span class="fc" id="L501">        return r;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>